<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0f172a">
  <title>Gelato Formulator</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="apple-touch-icon" href="./icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg-base: #0f172a; --bg-surface: #1e293b; --bg-elevated: #334155; --bg-hover: #3b4a63;
      --accent: #f59e0b; --accent-light: #fbbf24; --accent-soft: rgba(245, 158, 11, 0.15);
      --success: #10b981; --success-soft: rgba(16, 185, 129, 0.15);
      --warning: #f59e0b; --warning-soft: rgba(245, 158, 11, 0.15);
      --danger: #ef4444; --danger-soft: rgba(239, 68, 68, 0.15);
      --info: #3b82f6; --info-soft: rgba(59, 130, 246, 0.15);
      --purple: #8b5cf6; --purple-soft: rgba(139, 92, 246, 0.15);
      --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-muted: #64748b;
      --border: #334155; --border-light: #475569;
    }
    body { font-family: 'DM Sans', -apple-system, sans-serif; background: var(--bg-base); color: var(--text-primary); min-height: 100vh; }
    html { height: -webkit-fill-available; }
    #root { min-height: 100vh; display: flex; flex-direction: column; }
    .pin-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: linear-gradient(145deg, var(--bg-base), #1a1a2e); }
    .pin-logo { width: 80px; height: 80px; background: var(--accent-soft); border-radius: 24px; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 24px; }
    .pin-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .pin-subtitle { color: var(--text-muted); margin-bottom: 32px; }
    .pin-dots { display: flex; gap: 16px; margin-bottom: 40px; }
    .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--border-light); transition: all 0.2s; }
    .pin-dot.filled { background: var(--accent); border-color: var(--accent); }
    .pin-dot.error { border-color: var(--danger); background: var(--danger); animation: shake 0.5s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
    .pin-keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; width: 100%; max-width: 280px; }
    .pin-key { height: 64px; border-radius: 16px; background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-primary); font-size: 24px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .pin-key:hover { background: var(--bg-elevated); }
    .pin-key:active { transform: scale(0.95); }
    .pin-key.empty { visibility: hidden; }
    .app-container { flex: 1; display: flex; flex-direction: column; }
    .header { background: var(--bg-surface); border-bottom: 1px solid var(--border); padding: 16px 20px 0; position: sticky; top: 0; z-index: 100; }
    .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-icon { width: 40px; height: 40px; background: var(--accent-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .header-title { font-size: 20px; font-weight: 700; }
    .header-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--bg-elevated); border: none; color: var(--text-secondary); font-size: 18px; cursor: pointer; }
    .tabs { display: flex; gap: 4px; overflow-x: auto; }
    .tab { padding: 12px 16px; border: none; background: none; color: var(--text-muted); font-size: 14px; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab.test { color: var(--purple); }
    .tab.test.active { border-bottom-color: var(--purple); }
    .content { flex: 1; padding: 20px; overflow-y: auto; }
    .search-box { display: flex; align-items: center; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px; }
    .search-icon { color: var(--text-muted); margin-right: 12px; }
    .search-input { flex: 1; background: none; border: none; color: var(--text-primary); font-size: 16px; outline: none; }
    .search-input::placeholder { color: var(--text-muted); }
    .filter-chips { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
    .filter-chip { padding: 8px 14px; border-radius: 20px; background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; }
    .filter-chip.active { background: var(--accent-soft); border-color: var(--accent); color: var(--accent); }
    .recipe-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .recipe-count { color: var(--text-muted); font-size: 14px; }
    .add-btn { padding: 10px 16px; border-radius: 10px; background: var(--accent); border: none; color: var(--bg-base); font-size: 14px; font-weight: 600; cursor: pointer; }
    .recipe-list { display: flex; flex-direction: column; gap: 12px; }
    .recipe-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s; }
    .recipe-card:hover { border-color: var(--border-light); }
    .recipe-card.test { border-left: 3px solid var(--purple); }
    .recipe-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
    .recipe-card-info { display: flex; align-items: center; gap: 12px; }
    .recipe-card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
    .recipe-card-icon.gelato { background: var(--accent-soft); }
    .recipe-card-icon.sorbet { background: var(--info-soft); }
    .recipe-card-name { font-weight: 600; margin-bottom: 4px; }
    .recipe-card-meta { font-size: 13px; color: var(--text-muted); }
    .recipe-card-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .recipe-card-badge.gelato { background: var(--accent-soft); color: var(--accent); }
    .recipe-card-badge.sorbet { background: var(--info-soft); color: var(--info); }
    .recipe-card-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .recipe-stat { text-align: center; }
    .recipe-stat-value { font-size: 15px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .recipe-stat-value.good { color: var(--success); }
    .recipe-stat-value.warning { color: var(--warning); }
    .recipe-stat-value.bad { color: var(--danger); }
    .recipe-stat-label { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    .detail-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
    .back-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--bg-surface); border: 1px solid var(--border); color: var(--text-secondary); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .detail-title { flex: 1; }
    .detail-name { font-size: 20px; font-weight: 700; }
    .detail-meta { font-size: 14px; color: var(--text-muted); }
    .detail-actions { display: flex; gap: 8px; }
    .detail-action-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-surface); border: 1px solid var(--border); font-size: 16px; cursor: pointer; }
    .detail-action-btn.danger { background: var(--danger-soft); border-color: transparent; }
    .scale-controls { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 20px; padding: 14px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; }
    .scale-btn { width: 48px; height: 48px; border-radius: 12px; background: var(--accent-soft); border: none; color: var(--accent); font-size: 24px; font-weight: 700; cursor: pointer; }
    .scale-btn:active { transform: scale(0.95); }
    .scale-info { text-align: center; }
    .scale-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
    .scale-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent); }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .stat-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .stat-card-label { font-size: 13px; color: var(--text-muted); }
    .stat-card-target { font-size: 11px; color: var(--text-muted); }
    .stat-card-value { font-size: 28px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .stat-card-value.good { color: var(--success); }
    .stat-card-value.warning { color: var(--warning); }
    .stat-card-value.bad { color: var(--danger); }
    .stat-card-bar { height: 4px; background: var(--bg-elevated); border-radius: 2px; margin-top: 8px; }
    .stat-card-fill { height: 100%; border-radius: 2px; }
    .stat-card-fill.good { background: var(--success); }
    .stat-card-fill.warning { background: var(--warning); }
    .stat-card-fill.bad { background: var(--danger); }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
    .section-btn { padding: 8px 14px; border-radius: 8px; background: var(--accent-soft); border: none; color: var(--accent); font-size: 13px; font-weight: 600; cursor: pointer; }
    .ingredients-list { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .ingredient-row { display: flex; align-items: center; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .ingredient-row:last-child { border-bottom: none; }
    .ingredient-name { flex: 1; font-size: 15px; }
    .ingredient-amount-input { background: transparent; border: none; width: 70px; text-align: right; font-family: 'JetBrains Mono'; font-size: 15px; font-weight: 600; color: var(--accent); }
    .ingredient-amount-input:focus { outline: none; }
    .ingredient-unit { color: var(--text-muted); margin: 0 12px 0 4px; }
    .ingredient-remove { width: 32px; height: 32px; border-radius: 8px; background: var(--danger-soft); border: none; color: var(--danger); font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .ingredient-total { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: var(--bg-elevated); font-weight: 600; }
    .ingredient-total-value { font-size: 18px; font-family: 'JetBrains Mono', monospace; color: var(--accent); }
    .ing-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
    .ing-card-name { font-weight: 600; margin-bottom: 6px; }
    .ing-card-stats { display: flex; flex-wrap: wrap; gap: 8px; }
    .ing-card-stat { font-size: 12px; color: var(--text-muted); background: var(--bg-base); padding: 4px 8px; border-radius: 6px; }
    .ing-card-stat span { color: var(--text-primary); font-weight: 600; font-family: 'JetBrains Mono'; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: flex-end; justify-content: center; z-index: 1000; padding: 20px; }
    .modal { background: var(--bg-surface); border-radius: 20px 20px 0 0; width: 100%; max-width: 500px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-elevated); border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .modal-content { flex: 1; overflow-y: auto; padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; }
    .modal-btn.primary { background: var(--accent); color: var(--bg-base); }
    .modal-btn.secondary { background: var(--bg-elevated); color: var(--text-primary); }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .form-input { width: 100%; padding: 14px 16px; border-radius: 12px; background: var(--bg-base); border: 1px solid var(--border); color: var(--text-primary); font-size: 16px; font-family: inherit; }
    .form-input:focus { outline: none; border-color: var(--accent); }
    .form-select { width: 100%; padding: 14px 16px; border-radius: 12px; background: var(--bg-base); border: 1px solid var(--border); color: var(--text-primary); font-size: 16px; cursor: pointer; }
    .search-results { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; margin-top: 8px; max-height: 250px; overflow-y: auto; }
    .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: var(--bg-hover); }
    .search-result-name { font-weight: 500; margin-bottom: 4px; }
    .search-result-meta { font-size: 12px; color: var(--text-muted); }
    .settings-section { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; margin-bottom: 16px; }
    .settings-section-title { padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; background: var(--bg-elevated); border-bottom: 1px solid var(--border); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid var(--border); cursor: pointer; }
    .settings-item:last-child { border-bottom: none; }
    .settings-item:hover { background: var(--bg-elevated); }
    .settings-item-label { font-size: 15px; }
    .settings-item-value { font-size: 14px; color: var(--text-muted); }
    .settings-item.danger .settings-item-label { color: var(--danger); }
    .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 500; z-index: 1001; animation: slideUp 0.3s; }
    @keyframes slideUp { from{opacity:0;transform:translateX(-50%) translateY(20px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
    .test-info { background: var(--purple-soft); border: 1px solid var(--purple); border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    .test-info-title { color: var(--purple); font-weight: 600; margin-bottom: 4px; }
    .test-info-text { font-size: 13px; color: var(--text-secondary); }
    @media (min-width: 768px) { .content { max-width: 600px; margin: 0 auto; } .stats-grid { grid-template-columns: repeat(4, 1fr); } .modal { border-radius: 20px; margin: auto; } }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;
    const APP_VERSION = '5.0.0', BUILD_DATE = '2025-12-09', CORRECT_PIN = '0119';
    
    const INGREDIENT_DB = [
      { id: 1, name: 'Whole Milk 3.6%', fat: 3.6, sugar: 4.8, msnf: 8.9, fiber: 0, pac: 4.8, pod: 16, category: 'dairy' },
      { id: 2, name: 'Cream 38%', fat: 38, sugar: 2.8, msnf: 5.5, fiber: 0, pac: 2.8, pod: 9.3, category: 'dairy' },
      { id: 3, name: 'Cream 40%', fat: 40, sugar: 2.7, msnf: 5.2, fiber: 0, pac: 2.7, pod: 9, category: 'dairy' },
      { id: 4, name: 'Cream 35%', fat: 35, sugar: 2.9, msnf: 5.8, fiber: 0, pac: 2.9, pod: 9.7, category: 'dairy' },
      { id: 5, name: 'Skim Milk Powder (SMP)', fat: 0.8, sugar: 52, msnf: 97, fiber: 0, pac: 52, pod: 52, category: 'dairy' },
      { id: 6, name: 'Buttermilk', fat: 0.9, sugar: 4.8, msnf: 8.5, fiber: 0, pac: 4.8, pod: 16, category: 'dairy' },
      { id: 7, name: 'Whole Milk Powder', fat: 26, sugar: 38, msnf: 70, fiber: 0, pac: 38, pod: 38, category: 'dairy' },
      { id: 8, name: 'Cream Cheese', fat: 32.14, sugar: 3.5, msnf: 5, fiber: 0, pac: 3.5, pod: 0, category: 'dairy' },
      { id: 9, name: 'Mascarpone', fat: 44, sugar: 3, msnf: 4, fiber: 0, pac: 3, pod: 0, category: 'dairy' },
      { id: 10, name: 'Sucrose (White Sugar)', fat: 0, sugar: 100, msnf: 0, fiber: 0, pac: 100, pod: 100, category: 'sugar' },
      { id: 11, name: 'Dextrose', fat: 0, sugar: 92, msnf: 0, fiber: 0, pac: 180, pod: 70, category: 'sugar' },
      { id: 12, name: 'Glucose Syrup DE 40 (Caullet)', fat: 0, sugar: 80, msnf: 0, fiber: 0, pac: 90, pod: 45, category: 'sugar' },
      { id: 13, name: 'Glucose Powder 42DE', fat: 0, sugar: 95, msnf: 0, fiber: 0, pac: 100, pod: 50, category: 'sugar' },
      { id: 14, name: 'Trimoline (Invert Sugar)', fat: 0, sugar: 82, msnf: 0, fiber: 0, pac: 190, pod: 170, category: 'sugar' },
      { id: 15, name: 'Inulin', fat: 0, sugar: 0, msnf: 0, fiber: 90, pac: 10, pod: 10, category: 'sugar' },
      { id: 16, name: 'Maltodextrin', fat: 0, sugar: 95, msnf: 0, fiber: 0, pac: 50, pod: 30, category: 'sugar' },
      { id: 17, name: 'Honey', fat: 0, sugar: 82, msnf: 0, fiber: 0, pac: 97, pod: 130, category: 'sugar' },
      { id: 20, name: 'Tara Gum', fat: 0, sugar: 0, msnf: 0, fiber: 80, pac: 0, pod: 0, category: 'stabilizer' },
      { id: 21, name: 'Guar Gum', fat: 0, sugar: 0, msnf: 0, fiber: 80, pac: 0, pod: 0, category: 'stabilizer' },
      { id: 22, name: 'Locust Bean Gum (LBG)', fat: 0, sugar: 0, msnf: 0, fiber: 80, pac: 0, pod: 0, category: 'stabilizer' },
      { id: 23, name: 'Kappa Carrageenan', fat: 0, sugar: 0, msnf: 0, fiber: 0, pac: 0, pod: 0, category: 'stabilizer' },
      { id: 30, name: 'Water', fat: 0, sugar: 0, msnf: 0, fiber: 0, pac: 0, pod: 0, category: 'other' },
      { id: 31, name: 'Sea Salt', fat: 0, sugar: 0, msnf: 0, fiber: 0, pac: 0, pod: 0, category: 'other' },
      { id: 37, name: 'Espresso Beans (Ground)', fat: 11, sugar: 0, msnf: 0, fiber: 35, pac: 0, pod: 0, category: 'other' },
      { id: 40, name: 'Coconut Oil', fat: 100, sugar: 0, msnf: 0, fiber: 0, pac: 0, pod: 0, category: 'fats' },
      { id: 41, name: 'Extra Virgin Olive Oil', fat: 100, sugar: 0, msnf: 0, fiber: 0, pac: 0, pod: 0, category: 'fats' },
      { id: 50, name: 'Cocoa Powder 22-24%', fat: 23, sugar: 0, msnf: 0, fiber: 33, pac: 0, pod: 0, category: 'chocolate' },
      { id: 51, name: 'Callebaut 70.5% Chocolate', fat: 41, sugar: 28, msnf: 0, fiber: 11, pac: 28, pod: 28, category: 'chocolate' },
      { id: 52, name: 'Dark Chocolate 66%', fat: 35.71, sugar: 35.71, msnf: 0, fiber: 14.24, pac: 31, pod: 31, category: 'chocolate' },
      { id: 70, name: 'Lemon Juice', fat: 0, sugar: 2.5, msnf: 0, fiber: 0.3, pac: 4.75, pod: 2.5, category: 'fruit-citrus' },
      { id: 87, name: 'Cranberry Pur√©e (unsweetened)', fat: 0.1, sugar: 4, msnf: 0, fiber: 4.6, pac: 8, pod: 6, category: 'fruit-berry' },
      { id: 89, name: 'Lemon Zest', fat: 0.3, sugar: 0, msnf: 0, fiber: 10, pac: 0, pod: 0, category: 'fruit-citrus' },
      { id: 80, name: 'Strawberry Pur√©e', fat: 0.3, sugar: 5, msnf: 0, fiber: 2, pac: 9.5, pod: 10, category: 'fruit-berry' },
      { id: 84, name: 'Boiron Blueberry', fat: 0.3, sugar: 10, msnf: 0, fiber: 2.4, pac: 19, pod: 11, category: 'fruit-berry' },
      { id: 90, name: 'Passion Fruit Pur√©e', fat: 0.7, sugar: 11, msnf: 0, fiber: 10, pac: 21, pod: 12, category: 'fruit-tropical' },
      { id: 92, name: 'Coconut Pur√©e (Boiron)', fat: 15.15, sugar: 12.12, msnf: 0, fiber: 1.25, pac: 5.7, pod: 3, category: 'fruit-tropical' },
      { id: 106, name: 'Rhubarb Strawberry Pur√©e', fat: 0.2, sugar: 4, msnf: 0, fiber: 2, pac: 7.6, pod: 8, category: 'fruit-other' },
    ];
    
    const CATEGORIES = [
      { id: 'all', name: 'All' }, { id: 'dairy', name: 'Dairy' }, { id: 'sugar', name: 'Sugar' }, { id: 'stabilizer', name: 'Stabilizer' },
      { id: 'fats', name: 'Fats' }, { id: 'chocolate', name: 'Chocolate' }, { id: 'fruit-citrus', name: 'Citrus' },
      { id: 'fruit-berry', name: 'Berry' }, { id: 'fruit-tropical', name: 'Tropical' }, { id: 'fruit-other', name: 'Other Fruit' }, { id: 'other', name: 'Other' },
    ];
    
    const DEFAULT_RECIPES = [
      { id: 1, name: 'Chocolate Sorbet', type: 'sorbet', items: [{ ingredientId: 30, amount: 2600 }, { ingredientId: 10, amount: 800 }, { ingredientId: 11, amount: 240 }, { ingredientId: 16, amount: 100 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 50, amount: 240 }] },
      { id: 2, name: 'Buttermilk Gelato', type: 'gelato', items: [{ ingredientId: 1, amount: 1431 }, { ingredientId: 4, amount: 858 }, { ingredientId: 6, amount: 716 }, { ingredientId: 10, amount: 626 }, { ingredientId: 11, amount: 179 }, { ingredientId: 13, amount: 89.5 }, { ingredientId: 5, amount: 89.5 }, { ingredientId: 20, amount: 13.5 }] },
      { id: 3, name: 'Chocolate Gelato w/ Callebaut 70.5%', type: 'gelato', items: [{ ingredientId: 1, amount: 2405 }, { ingredientId: 13, amount: 185 }, { ingredientId: 11, amount: 148 }, { ingredientId: 5, amount: 111 }, { ingredientId: 50, amount: 67 }, { ingredientId: 10, amount: 259 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 51, amount: 740 }, { ingredientId: 14, amount: 74 }] },
      { id: 4, name: 'Blueberry-Coconut Sorbet', type: 'sorbet', items: [{ ingredientId: 92, amount: 998 }, { ingredientId: 84, amount: 1996 }, { ingredientId: 10, amount: 499 }, { ingredientId: 13, amount: 200 }, { ingredientId: 11, amount: 200 }, { ingredientId: 30, amount: 100 }, { ingredientId: 20, amount: 13.5 }] },
      { id: 5, name: 'Strawberry Gelato', type: 'gelato', items: [{ ingredientId: 80, amount: 1186 }, { ingredientId: 1, amount: 822 }, { ingredientId: 3, amount: 889 }, { ingredientId: 10, amount: 267 }, { ingredientId: 11, amount: 283 }, { ingredientId: 13, amount: 118 }, { ingredientId: 5, amount: 89 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 30, amount: 334 }] },
      { id: 6, name: 'Passion Fruit Sorbet', type: 'sorbet', items: [{ ingredientId: 90, amount: 1200 }, { ingredientId: 70, amount: 40 }, { ingredientId: 10, amount: 720 }, { ingredientId: 11, amount: 120 }, { ingredientId: 13, amount: 160 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 30, amount: 1420 }, { ingredientId: 15, amount: 320 }] },
      { id: 7, name: 'Coconut-Vanilla Gelato', type: 'gelato', items: [{ ingredientId: 3, amount: 68 }, { ingredientId: 1, amount: 1689 }, { ingredientId: 92, amount: 1351 }, { ingredientId: 10, amount: 676 }, { ingredientId: 11, amount: 68 }, { ingredientId: 13, amount: 68 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 40, amount: 68 }] },
      { id: 8, name: 'Fior di Latte', type: 'gelato', items: [{ ingredientId: 1, amount: 2220 }, { ingredientId: 3, amount: 800 }, { ingredientId: 10, amount: 560 }, { ingredientId: 13, amount: 140 }, { ingredientId: 11, amount: 80 }, { ingredientId: 5, amount: 180 }, { ingredientId: 20, amount: 13.5 }] },
      { id: 9, name: 'Lemon Olive Oil Gelato', type: 'gelato', items: [{ ingredientId: 1, amount: 1600 }, { ingredientId: 3, amount: 400 }, { ingredientId: 5, amount: 180 }, { ingredientId: 10, amount: 560 }, { ingredientId: 13, amount: 300 }, { ingredientId: 11, amount: 200 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 41, amount: 160 }, { ingredientId: 30, amount: 700 }] },
      { id: 10, name: 'Chocolate Gelato w/ Callebaut 66%', type: 'gelato', items: [{ ingredientId: 1, amount: 2600 }, { ingredientId: 13, amount: 200 }, { ingredientId: 11, amount: 160 }, { ingredientId: 5, amount: 120 }, { ingredientId: 50, amount: 72 }, { ingredientId: 10, amount: 200 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 52, amount: 600 }, { ingredientId: 14, amount: 40 }] },
      { id: 11, name: 'Rhubarb Strawberry Gelato', type: 'gelato', items: [{ ingredientId: 106, amount: 1154 }, { ingredientId: 1, amount: 865 }, { ingredientId: 3, amount: 865 }, { ingredientId: 10, amount: 260 }, { ingredientId: 11, amount: 360 }, { ingredientId: 13, amount: 115 }, { ingredientId: 5, amount: 87 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 30, amount: 288 }] },
      { id: 12, name: 'Fior di Latte TEST (Caullet Syrup)', type: 'gelato', items: [{ ingredientId: 1, amount: 1131 }, { ingredientId: 2, amount: 400 }, { ingredientId: 5, amount: 72 }, { ingredientId: 10, amount: 185 }, { ingredientId: 11, amount: 60 }, { ingredientId: 12, amount: 172 }, { ingredientId: 20, amount: 4 }, { ingredientId: 21, amount: 2.5 }, { ingredientId: 23, amount: 1 }] },
      { id: 13, name: 'Salted Caramel Gelato', type: 'gelato', items: [{ ingredientId: 10, amount: 579.4 }, { ingredientId: 31, amount: 16 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 1, amount: 2597.4 }, { ingredientId: 3, amount: 479.5 }, { ingredientId: 5, amount: 179.8 }, { ingredientId: 13, amount: 105 }, { ingredientId: 15, amount: 80 }] },
      { id: 14, name: 'Mocha Gelato', type: 'gelato', items: [{ ingredientId: 1, amount: 2220 }, { ingredientId: 3, amount: 800 }, { ingredientId: 10, amount: 560 }, { ingredientId: 13, amount: 140 }, { ingredientId: 11, amount: 80 }, { ingredientId: 5, amount: 180 }, { ingredientId: 20, amount: 13.5 }, { ingredientId: 37, amount: 100 }, { ingredientId: 50, amount: 60 }] },
    ];

    const DEFAULT_TEST_RECIPES = [
      { id: 100, name: 'Fior di Latte TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2200 }, { ingredientId: 2, amount: 700 }, { ingredientId: 5, amount: 100 }, { ingredientId: 10, amount: 500 }, { ingredientId: 11, amount: 100 }, { ingredientId: 12, amount: 340 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 101, name: 'Buttermilk Gelato TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 1200 }, { ingredientId: 4, amount: 720 }, { ingredientId: 6, amount: 700 }, { ingredientId: 10, amount: 560 }, { ingredientId: 11, amount: 140 }, { ingredientId: 12, amount: 200 }, { ingredientId: 5, amount: 60 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 400 }] },
      { id: 102, name: 'Strawberry Gelato TEST', type: 'gelato', items: [{ ingredientId: 80, amount: 1300 }, { ingredientId: 1, amount: 600 }, { ingredientId: 3, amount: 820 }, { ingredientId: 10, amount: 460 }, { ingredientId: 11, amount: 220 }, { ingredientId: 12, amount: 180 }, { ingredientId: 5, amount: 60 }, { ingredientId: 15, amount: 60 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 280 }] },
      { id: 103, name: 'Coconut-Vanilla Gelato TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 1700 }, { ingredientId: 3, amount: 100 }, { ingredientId: 92, amount: 1100 }, { ingredientId: 10, amount: 560 }, { ingredientId: 11, amount: 100 }, { ingredientId: 12, amount: 180 }, { ingredientId: 40, amount: 40 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 200 }] },
      { id: 104, name: 'Chocolate 70.5% TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2100 }, { ingredientId: 10, amount: 320 }, { ingredientId: 11, amount: 130 }, { ingredientId: 12, amount: 220 }, { ingredientId: 5, amount: 80 }, { ingredientId: 50, amount: 55 }, { ingredientId: 51, amount: 680 }, { ingredientId: 14, amount: 70 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 320 }] },
      { id: 105, name: 'Chocolate 66% TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2200 }, { ingredientId: 3, amount: 200 }, { ingredientId: 10, amount: 320 }, { ingredientId: 11, amount: 150 }, { ingredientId: 12, amount: 220 }, { ingredientId: 5, amount: 90 }, { ingredientId: 50, amount: 60 }, { ingredientId: 52, amount: 520 }, { ingredientId: 14, amount: 35 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 160 }] },
      { id: 106, name: 'Lemon Olive Oil TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2300 }, { ingredientId: 3, amount: 320 }, { ingredientId: 5, amount: 120 }, { ingredientId: 10, amount: 480 }, { ingredientId: 11, amount: 150 }, { ingredientId: 12, amount: 300 }, { ingredientId: 70, amount: 60 }, { ingredientId: 41, amount: 80 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 170 }] },
      { id: 107, name: 'Rhubarb Strawberry TEST', type: 'gelato', items: [{ ingredientId: 106, amount: 1300 }, { ingredientId: 1, amount: 700 }, { ingredientId: 3, amount: 780 }, { ingredientId: 10, amount: 480 }, { ingredientId: 11, amount: 240 }, { ingredientId: 12, amount: 200 }, { ingredientId: 5, amount: 60 }, { ingredientId: 15, amount: 60 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }, { ingredientId: 30, amount: 160 }] },
      { id: 108, name: 'Salted Caramel TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2400 }, { ingredientId: 3, amount: 400 }, { ingredientId: 5, amount: 130 }, { ingredientId: 10, amount: 500 }, { ingredientId: 11, amount: 100 }, { ingredientId: 12, amount: 220 }, { ingredientId: 31, amount: 16 }, { ingredientId: 15, amount: 80 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 109, name: 'Mocha Gelato TEST', type: 'gelato', items: [{ ingredientId: 1, amount: 2100 }, { ingredientId: 2, amount: 680 }, { ingredientId: 5, amount: 100 }, { ingredientId: 10, amount: 480 }, { ingredientId: 11, amount: 95 }, { ingredientId: 12, amount: 300 }, { ingredientId: 37, amount: 100 }, { ingredientId: 50, amount: 55 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 110, name: 'Chocolate Sorbet TEST', type: 'sorbet', items: [{ ingredientId: 30, amount: 2400 }, { ingredientId: 10, amount: 560 }, { ingredientId: 11, amount: 130 }, { ingredientId: 12, amount: 160 }, { ingredientId: 15, amount: 120 }, { ingredientId: 50, amount: 220 }, { ingredientId: 70, amount: 40 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 111, name: 'Blueberry-Coconut Sorbet TEST', type: 'sorbet', items: [{ ingredientId: 92, amount: 900 }, { ingredientId: 84, amount: 1800 }, { ingredientId: 10, amount: 480 }, { ingredientId: 11, amount: 160 }, { ingredientId: 12, amount: 160 }, { ingredientId: 15, amount: 120 }, { ingredientId: 70, amount: 60 }, { ingredientId: 30, amount: 300 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 112, name: 'Passion Fruit Sorbet TEST', type: 'sorbet', items: [{ ingredientId: 90, amount: 1100 }, { ingredientId: 10, amount: 560 }, { ingredientId: 11, amount: 140 }, { ingredientId: 12, amount: 160 }, { ingredientId: 15, amount: 140 }, { ingredientId: 70, amount: 60 }, { ingredientId: 30, amount: 1820 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
      { id: 113, name: 'Cranberry Lemon Sorbet TEST', type: 'sorbet', items: [{ ingredientId: 87, amount: 1400 }, { ingredientId: 70, amount: 200 }, { ingredientId: 89, amount: 8 }, { ingredientId: 10, amount: 700 }, { ingredientId: 11, amount: 180 }, { ingredientId: 12, amount: 300 }, { ingredientId: 30, amount: 1200 }, { ingredientId: 20, amount: 8 }, { ingredientId: 21, amount: 5 }, { ingredientId: 23, amount: 2 }] },
    ];
    
    const GELATO_TARGETS = { fat: { min: 6, max: 10, ideal: 9 }, sugar: { min: 22, max: 27, ideal: 25 }, msnf: { min: 7, max: 11, ideal: 9 }, solids: { min: 36, max: 42, ideal: 38 } };
    const SORBET_TARGETS = { fat: { min: 0, max: 3, ideal: 0 }, sugar: { min: 22, max: 32, ideal: 28 }, msnf: { min: 0, max: 2, ideal: 0 }, solids: { min: 28, max: 36, ideal: 31 } };
    
    function calculateStats(items) {
      let totalWeight = 0, totalFat = 0, totalSugar = 0, totalMSNF = 0, totalSolids = 0, totalPAC = 0;
      items.forEach(item => { const ing = INGREDIENT_DB.find(i => i.id === item.ingredientId); if (!ing) return; const amt = item.amount; totalWeight += amt; totalFat += (ing.fat / 100) * amt; totalSugar += (ing.sugar / 100) * amt; totalMSNF += (ing.msnf / 100) * amt; totalPAC += (ing.pac / 100) * amt; const water = 100 - ing.fat - ing.sugar - ing.msnf - ing.fiber; totalSolids += (1 - Math.max(0, water) / 100) * amt; });
      if (totalWeight === 0) return { fat: 0, sugar: 0, msnf: 0, solids: 0, totalWeight: 0, freezingPoint: 0 };
      return { fat: (totalFat / totalWeight) * 100, sugar: (totalSugar / totalWeight) * 100, msnf: (totalMSNF / totalWeight) * 100, solids: (totalSolids / totalWeight) * 100, totalWeight, freezingPoint: -(totalPAC / totalWeight) * 0.1 };
    }
    
    function getStatus(v, t) { if (v >= t.min && v <= t.max) return 'good'; if (v >= t.min - 2 && v <= t.max + 2) return 'warning'; return 'bad'; }
    
    function scaleRecipe(recipe, targetWeight) {
      const currentStats = calculateStats(recipe.items);
      const currentWeight = currentStats.totalWeight;
      if (currentWeight === 0) return recipe;
      const factor = targetWeight / currentWeight;
      return { ...recipe, items: recipe.items.map(item => ({ ...item, amount: Math.round(item.amount * factor * 10) / 10 })) };
    }
    
    function PinScreen({ onSuccess }) {
      const [pin, setPin] = useState(''); const [error, setError] = useState(false);
      const handleKey = (k) => { if (k === 'del') { setPin(p => p.slice(0, -1)); setError(false); } else if (pin.length < 4) { const np = pin + k; setPin(np); if (np.length === 4) { if (np === CORRECT_PIN) setTimeout(() => onSuccess(), 150); else { setError(true); setTimeout(() => { setPin(''); setError(false); }, 600); } } } };
      return (<div className="pin-screen"><div className="pin-logo">üç®</div><div className="pin-title">Gelato Formulator</div><div className="pin-subtitle">Enter PIN</div><div className="pin-dots">{[0,1,2,3].map(i => <div key={i} className={`pin-dot ${pin.length > i ? 'filled' : ''} ${error ? 'error' : ''}`} />)}</div><div className="pin-keypad">{[1,2,3,4,5,6,7,8,9,'',0,'del'].map((k,i) => <button key={i} className={`pin-key ${k===''?'empty':''}`} onClick={() => k!=='' && handleKey(String(k))}>{k==='del'?'‚å´':k}</button>)}</div></div>);
    }
    
    function App() {
      const [isAuth, setIsAuth] = useState(false); const [tab, setTab] = useState('recipes'); const [recipes, setRecipes] = useState([]); const [testRecipes, setTestRecipes] = useState([]); const [selected, setSelected] = useState(null); const [modal, setModal] = useState(null); const [toast, setToast] = useState(null); const [editing, setEditing] = useState(null);
      const [recipeSearch, setRecipeSearch] = useState(''); const [recipeFilter, setRecipeFilter] = useState('all'); const [ingSearch, setIngSearch] = useState(''); const [ingCategory, setIngCategory] = useState('all');
      useEffect(() => { if (sessionStorage.getItem('gelato-auth') === 'true') setIsAuth(true); const saved = localStorage.getItem('gelato-recipes-v5'); const savedTest = localStorage.getItem('gelato-test-recipes-v5'); setRecipes(saved ? JSON.parse(saved) : DEFAULT_RECIPES); setTestRecipes(savedTest ? JSON.parse(savedTest) : DEFAULT_TEST_RECIPES); }, []);
      useEffect(() => { if (recipes.length > 0) localStorage.setItem('gelato-recipes-v5', JSON.stringify(recipes)); }, [recipes]);
      useEffect(() => { if (testRecipes.length > 0) localStorage.setItem('gelato-test-recipes-v5', JSON.stringify(testRecipes)); }, [testRecipes]);
      const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 2500); };
      const isTestTab = tab === 'test';
      const currentRecipes = isTestTab ? testRecipes : recipes;
      const setCurrentRecipes = isTestTab ? setTestRecipes : setRecipes;
      const filteredRecipes = useMemo(() => currentRecipes.filter(r => r.name.toLowerCase().includes(recipeSearch.toLowerCase()) && (recipeFilter === 'all' || r.type === recipeFilter)).sort((a, b) => a.name.localeCompare(b.name)), [currentRecipes, recipeSearch, recipeFilter]);
      const filteredIngredients = useMemo(() => INGREDIENT_DB.filter(i => i.name.toLowerCase().includes(ingSearch.toLowerCase()) && (ingCategory === 'all' || i.category === ingCategory)).sort((a, b) => a.name.localeCompare(b.name)), [ingSearch, ingCategory]);
      const saveRecipe = (recipe) => { if (recipe.id && currentRecipes.find(r => r.id === recipe.id)) { setCurrentRecipes(r => r.map(x => x.id === recipe.id ? recipe : x)); setSelected(recipe); } else { const nr = { ...recipe, id: Date.now() }; setCurrentRecipes(r => [...r, nr]); setSelected(nr); } setModal(null); setEditing(null); showToast('Saved!'); };
      const deleteRecipe = (id) => { if (confirm('Delete?')) { setCurrentRecipes(r => r.filter(x => x.id !== id)); setSelected(null); showToast('Deleted'); } };
      const duplicateRecipe = (recipe) => { const nr = { ...recipe, id: Date.now(), name: recipe.name + ' (Copy)', items: recipe.items.map(i => ({...i})) }; setCurrentRecipes(r => [...r, nr]); setSelected(nr); showToast('Duplicated!'); };
      const handleScale = (delta) => { if (!selected) return; const stats = calculateStats(selected.items); const currentWeight = stats.totalWeight; const newWeight = Math.max(1000, Math.round((currentWeight + delta) / 1000) * 1000); const scaled = scaleRecipe(selected, newWeight); setCurrentRecipes(r => r.map(x => x.id === scaled.id ? scaled : x)); setSelected(scaled); showToast(`Scaled to ${newWeight}g`); };
      const exportData = () => { const d = JSON.stringify({ recipes, testRecipes, version: APP_VERSION }, null, 2); const b = new Blob([d], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `gelato-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); showToast('Exported!'); };
      const importData = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.recipes) { setRecipes(d.recipes); if (d.testRecipes) setTestRecipes(d.testRecipes); showToast('Imported!'); } } catch { showToast('Invalid'); } }; r.readAsText(f); };
      if (!isAuth) return <PinScreen onSuccess={() => { setIsAuth(true); sessionStorage.setItem('gelato-auth', 'true'); }} />;
      return (
        <div className="app-container">
          <header className="header"><div className="header-top"><div className="header-brand"><div className="header-icon">üç®</div><div className="header-title">Gelato Formulator</div></div><button className="header-btn" onClick={() => location.reload()}>‚Üª</button></div><div className="tabs"><button className={`tab ${tab === 'recipes' ? 'active' : ''}`} onClick={() => { setTab('recipes'); setSelected(null); }}>Recipes</button><button className={`tab test ${tab === 'test' ? 'active' : ''}`} onClick={() => { setTab('test'); setSelected(null); }}>Test Recipes</button><button className={`tab ${tab === 'ingredients' ? 'active' : ''}`} onClick={() => setTab('ingredients')}>Ingredients</button><button className={`tab ${tab === 'settings' ? 'active' : ''}`} onClick={() => setTab('settings')}>Settings</button></div></header>
          <div className="content">
            {(tab === 'recipes' || tab === 'test') && !selected && (<>{isTestTab && <div className="test-info"><div className="test-info-title">üß™ Test Recipes</div><div className="test-info-text">Optimized formulations using Caullet glucose syrup and Tara+Guar+Kappa stabilizer blend. Targets: 25% sugar, 9% fat, 38% solids (gelato) or 24-32% sugar, &gt;30% solids (sorbet).</div></div>}<div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search recipes..." value={recipeSearch} onChange={e => setRecipeSearch(e.target.value)} /></div><div className="filter-chips">{['all', 'gelato', 'sorbet'].map(f => <button key={f} className={`filter-chip ${recipeFilter === f ? 'active' : ''}`} onClick={() => setRecipeFilter(f)}>{f === 'all' ? 'All' : f.charAt(0).toUpperCase() + f.slice(1)}</button>)}</div><div className="recipe-header"><span className="recipe-count">{filteredRecipes.length} recipes</span><button className="add-btn" onClick={() => { setEditing({ name: '', type: 'gelato', items: [] }); setModal('recipe'); }}>+ New Recipe</button></div><div className="recipe-list">{filteredRecipes.map(recipe => { const stats = calculateStats(recipe.items); const targets = recipe.type === 'gelato' ? GELATO_TARGETS : SORBET_TARGETS; return (<div key={recipe.id} className={`recipe-card ${isTestTab ? 'test' : ''}`} onClick={() => setSelected(recipe)}><div className="recipe-card-header"><div className="recipe-card-info"><div className={`recipe-card-icon ${recipe.type}`}>{recipe.type === 'gelato' ? 'üç®' : 'üçß'}</div><div><div className="recipe-card-name">{recipe.name}</div><div className="recipe-card-meta">{recipe.items.length} ing ¬∑ {stats.totalWeight.toFixed(0)}g</div></div></div><span className={`recipe-card-badge ${recipe.type}`}>{recipe.type}</span></div><div className="recipe-card-stats">{[{k:'fat',l:'Fat'},{k:'sugar',l:'Sugar'},{k:'solids',l:'Solids'}].map(({k,l}) => <div key={k} className="recipe-stat"><div className={`recipe-stat-value ${getStatus(stats[k], targets[k])}`}>{stats[k].toFixed(1)}%</div><div className="recipe-stat-label">{l}</div></div>)}<div className="recipe-stat"><div className="recipe-stat-value" style={{color:'var(--info)'}}>{stats.freezingPoint.toFixed(1)}¬∞</div><div className="recipe-stat-label">FP</div></div></div></div>); })}</div></>)}
            {(tab === 'recipes' || tab === 'test') && selected && (() => { const stats = calculateStats(selected.items); const targets = selected.type === 'gelato' ? GELATO_TARGETS : SORBET_TARGETS; return (<><div className="detail-header"><button className="back-btn" onClick={() => setSelected(null)}>‚Üê</button><div className="detail-title"><div className="detail-name">{selected.name}</div><div className="detail-meta">{selected.type === 'gelato' ? 'üç®' : 'üçß'} {selected.type} ¬∑ {stats.totalWeight.toFixed(0)}g</div></div><div className="detail-actions"><button className="detail-action-btn" onClick={() => { setEditing(selected); setModal('recipe'); }}>‚úèÔ∏è</button><button className="detail-action-btn" onClick={() => duplicateRecipe(selected)}>üìã</button><button className="detail-action-btn danger" onClick={() => deleteRecipe(selected.id)}>üóëÔ∏è</button></div></div><div className="scale-controls"><button className="scale-btn" onClick={() => handleScale(-1000)}>‚àí</button><div className="scale-info"><div className="scale-label">Batch Size</div><div className="scale-value">{stats.totalWeight.toFixed(0)}g</div></div><button className="scale-btn" onClick={() => handleScale(1000)}>+</button></div><div className="stats-grid">{[{l:'Fat',k:'fat'},{l:'Sugar',k:'sugar'},{l:'MSNF',k:'msnf'},{l:'Solids',k:'solids'}].map(({l,k}) => { const v = stats[k], t = targets[k], s = getStatus(v, t), p = Math.min(100, (v / t.max) * 80); return <div key={k} className="stat-card"><div className="stat-card-header"><span className="stat-card-label">{l}</span><span className="stat-card-target">{t.min}-{t.max}%</span></div><div className={`stat-card-value ${s}`}>{v.toFixed(1)}%</div><div className="stat-card-bar"><div className={`stat-card-fill ${s}`} style={{width:`${p}%`}} /></div></div>; })}</div><div className="section-header"><span className="section-title">Ingredients</span><button className="section-btn" onClick={() => setModal('ingredient')}>+ Add</button></div><div className="ingredients-list">{selected.items.map((item, idx) => { const ing = INGREDIENT_DB.find(i => i.id === item.ingredientId); if (!ing) return null; return (<div key={idx} className="ingredient-row"><span className="ingredient-name">{ing.name}</span><input type="number" className="ingredient-amount-input" value={item.amount} onChange={e => { const updated = { ...selected, items: selected.items.map((it, i) => i === idx ? { ...it, amount: parseFloat(e.target.value) || 0 } : it) }; setCurrentRecipes(r => r.map(x => x.id === updated.id ? updated : x)); setSelected(updated); }} /><span className="ingredient-unit">g</span><button className="ingredient-remove" onClick={() => { const updated = { ...selected, items: selected.items.filter((_, i) => i !== idx) }; setCurrentRecipes(r => r.map(x => x.id === updated.id ? updated : x)); setSelected(updated); }}>√ó</button></div>); })}<div className="ingredient-total"><span>Total</span><span className="ingredient-total-value">{stats.totalWeight.toFixed(0)}g</span></div></div><div style={{marginTop:20,padding:16,background:'var(--bg-surface)',borderRadius:14,border:'1px solid var(--border)'}}><div style={{fontSize:12,color:'var(--text-muted)',marginBottom:8,textTransform:'uppercase'}}>Freezing Point</div><div style={{fontSize:24,fontWeight:700,fontFamily:'JetBrains Mono',color:'var(--info)'}}>{stats.freezingPoint.toFixed(2)}¬∞C</div><div style={{fontSize:12,color:'var(--text-muted)',marginTop:4}}>Target: -2.5 to -3.5¬∞C</div></div></>); })()}
            {tab === 'ingredients' && (<><div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search ingredients..." value={ingSearch} onChange={e => setIngSearch(e.target.value)} /></div><div className="filter-chips">{CATEGORIES.map(c => <button key={c.id} className={`filter-chip ${ingCategory === c.id ? 'active' : ''}`} onClick={() => setIngCategory(c.id)}>{c.name}</button>)}</div><div style={{color:'var(--text-muted)',fontSize:14,marginBottom:16}}>{filteredIngredients.length} ingredients</div>{filteredIngredients.map(ing => (<div key={ing.id} className="ing-card"><div className="ing-card-name">{ing.name}</div><div className="ing-card-stats"><div className="ing-card-stat">Fat <span>{ing.fat}%</span></div><div className="ing-card-stat">Sugar <span>{ing.sugar}%</span></div><div className="ing-card-stat">MSNF <span>{ing.msnf}%</span></div><div className="ing-card-stat">PAC <span>{ing.pac}</span></div><div className="ing-card-stat">POD <span>{ing.pod}</span></div></div></div>))}</>)}
            {tab === 'settings' && (<><div className="settings-section"><div className="settings-section-title">Data</div><div className="settings-item" onClick={exportData}><span className="settings-item-label">Export Backup</span><span className="settings-item-value">‚Üí</span></div><label className="settings-item"><span className="settings-item-label">Import Backup</span><input type="file" accept=".json" onChange={importData} style={{display:'none'}} /><span className="settings-item-value">‚Üí</span></label></div><div className="settings-section"><div className="settings-section-title">App Info</div><div className="settings-item"><span className="settings-item-label">Version</span><span className="settings-item-value">{APP_VERSION}</span></div><div className="settings-item"><span className="settings-item-label">Build</span><span className="settings-item-value">{BUILD_DATE}</span></div><div className="settings-item"><span className="settings-item-label">Recipes</span><span className="settings-item-value">{recipes.length}</span></div><div className="settings-item"><span className="settings-item-label">Test Recipes</span><span className="settings-item-value">{testRecipes.length}</span></div><div className="settings-item"><span className="settings-item-label">Ingredients</span><span className="settings-item-value">{INGREDIENT_DB.length}</span></div></div><div className="settings-section"><div className="settings-section-title" style={{color:'var(--danger)'}}>Danger Zone</div><div className="settings-item danger" onClick={() => { if (confirm('Reset all recipes?')) { setRecipes(DEFAULT_RECIPES); setTestRecipes(DEFAULT_TEST_RECIPES); setSelected(null); showToast('Reset!'); } }}><span className="settings-item-label">Reset All Data</span><span className="settings-item-value">‚Üí</span></div></div></>)}
          </div>
          {modal === 'recipe' && (<div className="modal-overlay" onClick={() => { setModal(null); setEditing(null); }}><div className="modal" onClick={e => e.stopPropagation()}><div className="modal-header"><span className="modal-title">{editing?.id ? 'Edit Recipe' : 'New Recipe'}</span><button className="modal-close" onClick={() => { setModal(null); setEditing(null); }}>√ó</button></div><div className="modal-content"><div className="form-group"><label className="form-label">Name</label><input type="text" className="form-input" placeholder="Recipe name" value={editing?.name || ''} onChange={e => setEditing({...editing, name: e.target.value})} autoFocus /></div><div className="form-group"><label className="form-label">Type</label><select className="form-select" value={editing?.type || 'gelato'} onChange={e => setEditing({...editing, type: e.target.value})}><option value="gelato">Gelato</option><option value="sorbet">Sorbet</option></select></div></div><div className="modal-footer"><button className="modal-btn secondary" onClick={() => { setModal(null); setEditing(null); }}>Cancel</button><button className="modal-btn primary" onClick={() => { if (editing?.name?.trim()) saveRecipe({...editing, items: editing.items || []}); }}>Save</button></div></div></div>)}
          {modal === 'ingredient' && selected && <AddIngredientModal onAdd={(id, amt) => { const updated = { ...selected, items: [...selected.items, { ingredientId: id, amount: amt }] }; setCurrentRecipes(r => r.map(x => x.id === updated.id ? updated : x)); setSelected(updated); setModal(null); }} onClose={() => setModal(null)} existingIds={selected.items.map(i => i.ingredientId)} />}
          {toast && <div className="toast">{toast}</div>}
        </div>
      );
    }
    
    function AddIngredientModal({ onAdd, onClose, existingIds }) {
      const [search, setSearch] = useState(''); const [selId, setSelId] = useState(null); const [amount, setAmount] = useState('');
      const filtered = useMemo(() => INGREDIENT_DB.filter(i => i.name.toLowerCase().includes(search.toLowerCase()) && !existingIds.includes(i.id)).slice(0, 15), [search, existingIds]);
      const selIng = selId ? INGREDIENT_DB.find(i => i.id === selId) : null;
      return (<div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}><div className="modal-header"><span className="modal-title">Add Ingredient</span><button className="modal-close" onClick={onClose}>√ó</button></div><div className="modal-content">{!selId ? (<><div className="form-group"><input type="text" className="form-input" placeholder="Search ingredients..." value={search} onChange={e => setSearch(e.target.value)} autoFocus /></div>{search && filtered.length > 0 && <div className="search-results">{filtered.map(ing => (<div key={ing.id} className="search-result-item" onClick={() => setSelId(ing.id)}><div className="search-result-name">{ing.name}</div><div className="search-result-meta">Fat: {ing.fat}% ¬∑ Sugar: {ing.sugar}% ¬∑ MSNF: {ing.msnf}%</div></div>))}</div>}</>) : (<><div className="form-group"><label className="form-label">Selected</label><div className="form-input" style={{cursor:'pointer'}} onClick={() => setSelId(null)}>{selIng?.name} <span style={{color:'var(--text-muted)',float:'right'}}>Change</span></div></div><div className="form-group"><label className="form-label">Amount (g)</label><input type="number" className="form-input" placeholder="e.g., 500" value={amount} onChange={e => setAmount(e.target.value)} autoFocus /></div></>)}</div><div className="modal-footer"><button className="modal-btn secondary" onClick={onClose}>Cancel</button><button className="modal-btn primary" onClick={() => selId && amount && onAdd(selId, parseFloat(amount))} style={{opacity:(!selId||!amount)?0.5:1}}>Add</button></div></div></div>);
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
